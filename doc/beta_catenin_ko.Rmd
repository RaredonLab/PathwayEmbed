---
title: "Beta-Catenin Knockout Analysis with PathwayEmbed"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Beta-Catenin Knockout Analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Overview
This vignette shows the application of PathwayEmbed in a beta-catenin perturbed system where Ctnnb1 upstream enhancer is depleted in instestinal epithelia. Refinements of coefficients is flexible and should be case-depedent.
References: Hua et al. A Ctnnb1 enhancer transcriptionally regulates Wnt signaling dosage to balance homeostasis and tumorigenesis of intestinal epithelia. Elife. 2024 Sep 25;13:RP98238. doi: 10.7554/eLife.98238. PMID: 39320349; PMCID: PMC11424096.

## Load Packages and Download Data from Online Source
```{r setup}
library(PathwayEmbed)
library(Seurat)

url_ko <- "https://ftp.ncbi.nlm.nih.gov/geo/series/GSE233nnn/GSE233978/suppl/GSE233978_KO_filtered_feature_bc_matrix.h5"
url_wt <- "https://ftp.ncbi.nlm.nih.gov/geo/series/GSE233nnn/GSE233978/suppl/GSE233978_WT_filtered_feature_bc_matrix.h5"


download.file(url_ko, destfile = "GSE233978_KO_filtered_feature_bc_matrix.h5", mode = "wb")
download.file(url_wt, destfile = "GSE233978_WT_filtered_feature_bc_matrix.h5", mode = "wb")
```

## Data Preparation
```{r}
# Load KO and WT expression matrices from local HDF5 files
ko_data <- Read10X_h5("GSE233978_KO_filtered_feature_bc_matrix.h5")
wt_data <- Read10X_h5("GSE233978_WT_filtered_feature_bc_matrix.h5")

# Create Seurat objects
# Apply during object creation
ko <- CreateSeuratObject(counts = ko_data, project = "KO", min.cells = 3, min.features = 200)
wt <- CreateSeuratObject(counts = wt_data, project = "WT", min.cells = 3, min.features = 200)


# Add sample metadata
ko$sample <- "KO"
wt$sample <- "WT"

# Merge and join layers
merged <- merge(ko, wt)
merged[["RNA"]] <- JoinLayers(merged[["RNA"]])
```

## Preprocessing 
Get normalized and scaled data
```{r}
# Normalize and scale
merged <- NormalizeData(
  object = merged,
  normalization.method = "LogNormalize",
  scale.factor = 10000
)

merged <- FindVariableFeatures(
  object = merged,
  selection.method = "vst",
  nfeatures = 2000
)

merged <- ScaleData(
  object = merged,
  features = VariableFeatures(object = merged)
)
```

## Wnt Pathway Scoring and Visualization Using Pathway Embed
```{r}
# Compute Wnt pathway score
wnt_scores <- ComputeCellData(merged, "Wnt", distance.method = "manhattan", batch.size = 1000)

# Prepare for plotting
plot_data <- PreparePlotData(merged, wnt_scores, group = "sample")

# Plot
PlotPathway(plot_data, pathway = "Wnt", group = "sample", c("#f4a4a4", "#6baed6"))

# Show percentage of high-scoring cells (optional)
CalculatePercentage(plot_data, "sample")
```
